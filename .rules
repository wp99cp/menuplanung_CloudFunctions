rules_version = '2';

// Security rules for eMeal Firebase Firestore Database
service cloud.firestore {
  match /databases/{database}/documents {

    // checks if the user is signed in
    function isAuth(){

        return request.auth != null;

    }

    // check's if the user has access to this document
    function hasAccess() {

        return resource.data.access[request.auth.uid] in ['owner', 'editor'];

    }

    // check's if the user is the owner of this document
    function isOwner(data) {

        return data.access[request.auth.uid] == 'owner';

    }

    // checks if the access property got changed and whether he is allowed to do this
    function checkAccessChanges(){

        return
            // nothing changed in access data
            request.resource.data.access == resource.data.access ||
            // only owners can change access data and only afterwards at least on owner exist
            (hasAccess() && 'owner' in request.resource.data.access.values());


    }


    // user collecion
    match /users/{userID} {

        // checks if the changes to a user document are valid
        function validChanges(){

            return
                request.resource.data.displayName is string &&
                // can't change it's email
                request.resource.data.email == resource.data.email &&
                // can't change it's own uid
                request.resource.data.visibility in ['visible', 'hidden'] &&
                // only this 3 fields are allowed
                request.resource.data.keys().hasAll(['displayName', 'email', 'visibility']) &&
                request.resource.data.size() == 3;

        }

        // A user only can edit it's own user document
        // He can only change it's displayed name and the visibility-properity
        allow update: if userID == request.auth.uid && validChanges();

        // all visible user can be listed if the requesting user is signed in
        allow list, get: if (resource.data.visibility == 'visible' || userID == request.auth.uid) && isAuth();

    }


    // shared data can be read but not write to it
    match /sharedData/{document=**} {

        allow read, list: if isAuth();

    }


    // camps colelction
    match /camps/{campID} {

        function validChanges(){

            return
                // participants fields are numbers
                request.resource.data.participants is number &&
                request.resource.data.vegetarier is number &&
                // has name
                request.resource.data.name.size() > 0;

        }

        // every auth user can create camps on which he has access
        allow create: if isAuth() && isOwner(request.resource.data) && validChanges();

        allow update: if hasAccess() && checkAccessChanges() && validChanges();
        allow list, get: if hasAccess();
        allow delete: if isOwner(resource.data);

    }
 


    // group query for delete specificRecipes
        match /{path=**}/specificRecipes/{specificRecipeID} {

            // TODO: not save
            allow read;
        }

    // Meals
    match /meals/{mealID} {

        function validChanges(){
            return 
                // has name
                request.resource.data.name is string &&
                request.resource.data.name.size() > 0;

        }

        allow create: if isAuth() && isOwner(request.resource.data) && validChanges();
        allow list, get: if hasAccess();
        allow update: if hasAccess() && checkAccessChanges() && validChanges();
        allow delete: if isOwner();



        // specific Meals
        match /specificMeals/{specificMealID} {
 
             function validChanges(){

               return true;

            }

            // TODO: add verification or access rules
            allow create:  if isAuth() && validChanges();
            allow get, list; // list is not allowed
            allow update: if validChanges();
            allow delete;

        }






        // recipes
        match /recipes/{recipeID} {

            function validChanges(){

                return true;

            }

            allow create: if isAuth() && isOwner(request.resource.data) && validChanges();
            allow list, get: if hasAccess();
            allow update: if hasAccess() && checkAccessChanges() && validChanges();
            allow delete: if isOwner();



            // specific recipes
             match /specificRecipes/{specificRecipeID} {
 
                function validChanges(){

                    return true;

                }

                // TODO: add verification or access rules
                allow create:  if isAuth() && validChanges();
                allow get, list; // list is not allowed
                allow update: if validChanges();
                allow delete;

            }


        }

    }


 }

}
